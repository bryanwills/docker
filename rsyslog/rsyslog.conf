# Load modules
module(load="imudp")
module(load="imtcp")

# Globals
global(
  workDirectory="/var/lib/rsyslog"
  maxMessageSize="64k"
)

# Inputs
input(type="imudp" port="514")
input(type="imtcp" port="514")

# ---- Templates ----
# Path template: logs/{YYYY}/{MM}/{MM-YYYY}.log  (LOCAL time)
template(
  name="MonthlyLog"
  type="string"
  string="/logs/%$year%/%$month%/%$month%-%$year%.log"
)

# Message template: use local server time, RFC3339 with offset
template(
  name="MsgLocalRFC3339"
  type="string"
  string="%timegenerated:::date-rfc3339% %hostname% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"
)

# Rule
if ($fromhost-ip != "127.0.0.1" and $fromhost-ip != "::1") then {
  action(
    type="omfile"
    dynaFile="MonthlyLog"
    template="MsgLocalRFC3339"
    createDirs="on"
    dirCreateMode="0755"
    fileCreateMode="0644"
  )
  stop
}