# Load modules
module(load="imudp")
module(load="imtcp")

# Globals
global(
  workDirectory="/var/lib/rsyslog"
  maxMessageSize="64k"
)

# Inputs
input(type="imudp" port="514")
input(type="imtcp" port="514")

# ---- Templates ----
# Path template: logs/{YYYY}/{MM}/{MM-YYYY}.log  (LOCAL time)
template(
  name="MonthlyLog"
  type="string"
  string="/logs/%$year%/%$month%/%$month%-%$year%.log"
)

# Message template: use local server time, RFC3339 with offset
template(
  name="MsgLocalRFC3339"
  type="string"
  string="%timegenerated:::date-rfc3339% %hostname% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"
)

# TCP-specific template with proper framing
template(
  name="TCPMsgFrame"
  type="string"
  string="%msg%\n"
)

# Rule: Log to local files AND forward to Graylog (both UDP and TCP)
if ($fromhost-ip != "127.0.0.1" and $fromhost-ip != "::1") then {
  # Log to local monthly files
  action(
    type="omfile"
    dynaFile="MonthlyLog"
    template="MsgLocalRFC3339"
    createDirs="on"
    dirCreateMode="0755"
    fileCreateMode="0644"
  )

  # Forward to Graylog UDP input (port 1515)
  action(
    type="omfwd"
    target="graylog-server"
    port="1515"
    protocol="udp"
    template="MsgLocalRFC3339"
  )

  # Forward to Graylog TCP input (port 1516) with proper framing
  action(
    type="omfwd"
    target="graylog-server"
    port="1516"
    protocol="tcp"
    template="TCPMsgFrame"
    action.resumeRetryCount="-1"
    action.resumeInterval="30"
    action.reportSuspension="on"
  )

  stop
}